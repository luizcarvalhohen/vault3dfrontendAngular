{"version":3,"file":"bc-ur-registry-eth.cjs.development.js","sources":["../src/RegistryType.ts","../src/EthSignRequest.ts","../src/EthSignature.ts","../src/utlis.ts","../src/index.ts"],"sourcesContent":["import { extend } from '@keystonehq/bc-ur-registry';\nconst { RegistryType } = extend;\n\nexport const ExtendedRegistryTypes = {\n    ETH_SIGN_REQUEST: new RegistryType('eth-sign-request', 401),\n    ETH_SIGNATAURE: new RegistryType('eth-signature', 402),\n};\n","import { CryptoKeypath, extend, DataItem, PathComponent, RegistryItem } from '@keystonehq/bc-ur-registry';\nimport { ExtendedRegistryTypes } from './RegistryType';\nimport * as uuid from 'uuid';\n\nconst { decodeToDataItem, RegistryTypes } = extend;\n\nenum Keys {\n    requestId = 1,\n    signData,\n    dataType,\n    chainId,\n    derivationPath,\n    address,\n    origin\n}\n\nexport enum DataType {\n    transaction = 1,\n    typedData = 2,\n    personalMessage = 3,\n    typedTransaction = 4,\n}\n\ntype signRequestProps = {\n    requestId?: Buffer;\n    signData: Buffer;\n    dataType: DataType;\n    chainId?: number;\n    derivationPath: CryptoKeypath;\n    address?: Buffer;\n    origin?: String;\n};\n\nexport class EthSignRequest extends RegistryItem {\n    private requestId: Buffer;\n    private signData: Buffer;\n    private dataType: DataType;\n    private chainId: number;\n    private derivationPath: CryptoKeypath;\n    private address: Buffer;\n    private origin: String;\n\n    getRegistryType = () => ExtendedRegistryTypes.ETH_SIGN_REQUEST;\n\n    constructor(args: signRequestProps) {\n        super();\n        this.setupData(args);\n    }\n\n    private setupData = (args: signRequestProps) => {\n        this.requestId = args.requestId;\n        this.signData = args.signData;\n        this.dataType = args.dataType;\n        this.chainId = args.chainId;\n        this.derivationPath = args.derivationPath;\n        this.address = args.address;\n        this.origin = args.origin;\n    };\n\n    public getRequestId = () => this.requestId;\n    public getSignData = () => this.signData;\n    public getDataType = () => this.dataType;\n    public getChainId = () => this.chainId;\n    public getDerivationPath = () => this.derivationPath.getPath();\n    public getSignRequestAddress = () => this.address;\n    public getOrigin = () => this.origin;\n\n    public toDataItem = () => {\n        const map = {};\n        if (this.requestId) {\n            map[Keys.requestId] = new DataItem(this.requestId, RegistryTypes.UUID.getTag());\n        }\n        if (this.address) {\n            map[Keys.address] = this.address;\n        }\n        if (this.chainId) {\n            map[Keys.chainId] = this.chainId;\n        }\n\n        if(this.origin) {\n            map[Keys.origin] = this.origin;\n        }\n\n        map[Keys.signData] = this.signData;\n        map[Keys.dataType] = this.dataType;\n\n        const keyPath = this.derivationPath.toDataItem();\n        keyPath.setTag(this.derivationPath.getRegistryType().getTag());\n        map[Keys.derivationPath] = keyPath;\n\n        return new DataItem(map);\n    };\n\n    public static fromDataItem = (dataItem) => {\n        const map = dataItem.getData();\n        const signData = map[Keys.signData];\n        const dataType = map[Keys.dataType];\n        const derivationPath = CryptoKeypath.fromDataItem(map[Keys.derivationPath]);\n        const chainId = map[Keys.chainId] ? map[Keys.chainId] : undefined;\n        const address = map[Keys.address] ? map[Keys.address] : undefined;\n        const requestId = map[Keys.requestId] ? map[Keys.requestId].getData() : undefined;\n        const origin = map[Keys.origin] ? map[Keys.origin] : undefined;\n\n        return new EthSignRequest({\n            requestId,\n            signData,\n            dataType,\n            chainId,\n            derivationPath,\n            address,\n            origin\n        });\n    };\n\n    public static fromCBOR = (_cborPayload: Buffer) => {\n        const dataItem = decodeToDataItem(_cborPayload);\n        return EthSignRequest.fromDataItem(dataItem);\n    };\n\n    public static constructETHRequest(\n        signData: Buffer,\n        signDataType: DataType,\n        hdPath: string,\n        xfp: string,\n        uuidString?: string,\n        chainId?: number,\n        address?: string,\n        origin?: string,\n    ) {\n        const paths = hdPath.replace(/[m|M]\\//, '').split('/');\n        const hdpathObject = new CryptoKeypath(\n            paths.map((path) => {\n                const index = parseInt(path.replace(\"'\", ''));\n                let isHardened = false;\n                if (path.endsWith(\"'\")) {\n                    isHardened = true;\n                }\n                return new PathComponent({ index, hardened: isHardened });\n            }),\n            Buffer.from(xfp, 'hex'),\n        );\n\n        return new EthSignRequest({\n            requestId: uuidString ? Buffer.from(uuid.parse(uuidString) as Uint8Array) : undefined,\n            signData,\n            dataType: signDataType,\n            derivationPath: hdpathObject,\n            chainId,\n            address: address ? Buffer.from(address.replace('0x', ''), 'hex') : undefined,\n            origin: origin || undefined,\n        });\n    }\n}\n","import { extend, DataItem, RegistryItem } from '@keystonehq/bc-ur-registry';\nimport { ExtendedRegistryTypes } from './RegistryType';\n\nconst { RegistryTypes, decodeToDataItem } = extend;\n\nenum Keys {\n    requestId = 1,\n    signature,\n}\n\nexport class ETHSignature extends RegistryItem {\n    private requestId: Buffer;\n    private signature: Buffer;\n\n    getRegistryType = () => ExtendedRegistryTypes.ETH_SIGNATAURE;\n\n    constructor(signature: Buffer, requestId?: Buffer) {\n        super();\n        this.signature = signature;\n        this.requestId = requestId;\n    }\n\n    public getRequestId = () => this.requestId;\n    public getSignature = () => this.signature;\n\n    public toDataItem = () => {\n        const map = {};\n        if (this.requestId) {\n            map[Keys.requestId] = new DataItem(this.requestId, RegistryTypes.UUID.getTag());\n        }\n        map[Keys.signature] = this.signature;\n        return new DataItem(map);\n    };\n\n    public static fromDataItem = (dataItem) => {\n        const map = dataItem.getData();\n        const signature = map[Keys.signature];\n        const requestId = map[Keys.requestId] ? map[Keys.requestId].getData() : undefined;\n\n        return new ETHSignature(signature, requestId);\n    };\n\n    public static fromCBOR = (_cborPayload: Buffer) => {\n        const dataItem = decodeToDataItem(_cborPayload);\n        return ETHSignature.fromDataItem(dataItem);\n    };\n}\n","// @ts-ignore\nimport HDKey from 'hdkey';\nimport { toChecksumAddress, publicToAddress } from 'ethereumjs-util';\n\nexport const generateAddressfromXpub = (xpub: string, derivePath: string) => {\n    // @ts-ignore\n    const node = HDKey.fromExtendedKey(xpub);\n    const publicKey = node.derive(derivePath);\n    const address = '0x' + publicToAddress(publicKey.publicKey, true).toString('hex');\n    return toChecksumAddress(address);\n};\n\nexport const findHDpatfromAddress = (address: string, xpub: string, numberLimit: number, rootPath: string) => {\n    for (let i = 0; i < numberLimit; i++) {\n        const path = `M/0/${i}`;\n        const caculateAddress = generateAddressfromXpub(xpub, path);\n        if (address.toLowerCase() == caculateAddress.toLowerCase()) {\n            return `${rootPath}/0/${i}`;\n        }\n    }\n    return null;\n};\n","export * from '@keystonehq/bc-ur-registry';\nimport { extend } from '@keystonehq/bc-ur-registry';\nimport { ExtendedRegistryTypes } from './RegistryType';\nconst { cbor } = extend;\ncbor.patchTags(\n    Object.values(ExtendedRegistryTypes)\n        .filter((rt) => !!rt.getTag())\n        .map((rt) => rt.getTag()),\n);\n\nexport { EthSignRequest, DataType } from './EthSignRequest';\nexport { ETHSignature } from './EthSignature';\n\nexport { generateAddressfromXpub, findHDpatfromAddress } from './utlis';\n"],"names":["RegistryType","extend","ExtendedRegistryTypes","ETH_SIGN_REQUEST","ETH_SIGNATAURE","decodeToDataItem","RegistryTypes","Keys","DataType","EthSignRequest","RegistryItem","constructor","args","requestId","signData","dataType","chainId","derivationPath","address","origin","getPath","map","DataItem","UUID","getTag","keyPath","toDataItem","setTag","getRegistryType","setupData","constructETHRequest","signDataType","hdPath","xfp","uuidString","paths","replace","split","hdpathObject","CryptoKeypath","path","index","parseInt","isHardened","endsWith","PathComponent","hardened","Buffer","from","uuid","undefined","dataItem","getData","fromDataItem","_cborPayload","ETHSignature","signature","generateAddressfromXpub","xpub","derivePath","node","HDKey","fromExtendedKey","publicKey","derive","publicToAddress","toString","toChecksumAddress","findHDpatfromAddress","numberLimit","rootPath","i","caculateAddress","toLowerCase","cbor","patchTags","Object","values","filter","rt"],"mappings":"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"}